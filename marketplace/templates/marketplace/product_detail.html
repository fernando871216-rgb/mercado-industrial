{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm border-0">
                {% if producto.imagen %}
                    <img src="{{ producto.imagen.url }}" class="img-fluid rounded shadow-sm" alt="{{ producto.nombre }}">
                {% else %}
                    <img src="https://via.placeholder.com/500" class="img-fluid rounded shadow-sm" alt="Sin imagen">
                {% endif %}
            </div>
        </div>

        <div class="col-md-6">
            <h1 class="display-5 fw-bold text-dark">{{ producto.nombre }}</h1>
            <h3 class="text-success mb-4">${{ producto.precio }} MXN</h3>
            
            <p class="text-muted">{{ producto.descripcion }}</p>

            <hr class="my-4">

            <div class="card p-4 border-0 shadow-sm" style="border-radius: 20px; background-color: #f8f9fa;">
                <h5 class="mb-3 d-flex align-items-center">
                    <span class="me-2">ðŸšš</span> Cotizar EnvÃ­o
                </h5>
                
                <div class="input-group mb-2">
                    <input type="text" id="cp_destino_input" class="form-control border-end-0" placeholder="CÃ³digo Postal Destino" maxlength="5">
                    <button type="button" id="btnCotizarRapido" class="btn btn-primary px-4">Calcular</button>
                    <button type="button" id="btnLimpiar" class="btn btn-outline-secondary border-start-0" title="Limpiar">âœ•</button>
                </div>

                <div id="loading_envio" class="text-center mt-3" style="display: none;">
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    <span class="ms-2 text-primary small fw-bold">Buscando tarifas...</span>
                </div>

                <div id="resultado_envio" class="mt-3" style="display: none; max-height: 200px; overflow-y: auto;">
                    <table class="table table-sm table-borderless align-middle">
                        <tbody id="tablaTarifasBody">
                            </tbody>
                    </table>
                </div>
            </div>
            <div class="d-grid gap-2 mt-4">
                <button class="btn btn-warning btn-lg fw-bold text-white shadow-sm" style="background-color: #f39c12; border: none;">
                    Confirmar IntenciÃ³n de Compra
                </button>
                <button class="btn btn-light btn-lg border shadow-sm d-flex align-items-center justify-content-center">
                    <img src="https://http2.mlstatic.com/frontend-assets/mp-web-navigation/ui-navigation/5.21.22/mercadopago/logo__small.png" height="20" class="me-2">
                    Pagar ahora
                </button>
            </div>
        </div>
    </div>
</div>

<input type="hidden" id="p_peso" value="{{ producto.peso|default:'1' }}">
<input type="hidden" id="p_largo" value="{{ producto.largo|default:'20' }}">
<input type="hidden" id="p_ancho" value="{{ producto.ancho|default:'20' }}">
<input type="hidden" id="p_alto" value="{{ producto.alto|default:'20' }}">

<script>
    const btnCotizar = document.getElementById('btnCotizarRapido');
    const btnLimpiar = document.getElementById('btnLimpiar');
    const inputCP = document.getElementById('cp_destino_input');
    const loading = document.getElementById('loading_envio');
    const resultado = document.getElementById('resultado_envio');
    const tabla = document.getElementById('tablaTarifasBody');

    btnLimpiar.addEventListener('click', () => {
        inputCP.value = '';
        tabla.innerHTML = '';
        resultado.style.display = 'none';
    });

    btnCotizar.addEventListener('click', function() {
        const cp_destino = inputCP.value.trim();

        if (!cp_destino || cp_destino.length < 5) {
            alert("Ingresa un CÃ³digo Postal vÃ¡lido.");
            return;
        }

        tabla.innerHTML = '';
        resultado.style.display = 'none';
        loading.style.display = 'block';

        const params = new URLSearchParams({
            cp_origen: '72460',
            cp_destino: cp_destino,
            peso: document.getElementById('p_peso').value,
            largo: document.getElementById('p_largo').value,
            ancho: document.getElementById('p_ancho').value,
            alto: document.getElementById('p_alto').value
        });

        fetch(`/cotizar-soloenvios/?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                if (data.tarifas && data.tarifas.length > 0) {
                    data.tarifas.forEach(t => {
                        const row = `
                            <tr class="border-bottom">
                                <td class="py-2">
                                    <div class="fw-bold text-dark" style="font-size: 0.9rem;">${t.paqueteria}</div>
                                    <div class="text-muted small">Llega en ${t.tiempo}</div>
                                </td>
                                <td class="text-end py-2 fw-bold text-success" style="font-size: 1rem;">
                                    $${t.precio_final}
                                </td>
                            </tr>`;
                        tabla.innerHTML += row;
                    });
                    resultado.style.display = 'block';
                } else {
                    alert("No hay tarifas disponibles. Intenta de nuevo.");
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                alert
