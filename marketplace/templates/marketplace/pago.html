<script src="https://sdk.mercadopago.com/js/v2"></script>
<script>
    const mp = new MercadoPago('APP_USR-67803862-f286-4f48-a006-8d541571f308', { locale: 'es-MX' });

    function actualizarPreferencia(montoFlete) {
        const display = document.getElementById('total-display');
        const container = document.getElementById('wallet_container');
        
        display.innerText = 'Calculando total...';
        container.innerHTML = '<p>Actualizando pago...</p>';

        // USAMOS LA RUTA QUE DJANGO SÍ CONOCE
        // Esto evita el error 404 de /actualizar-pago/
        const url = `/generar-preferencia/{{ producto.id }}/?envio=${montoFlete}`;
        
        console.log("Intentando conectar a:", url);

        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error('No se encontró la ruta en el servidor');
                return response.json();
            })
            .then(data => {
                // Aquí ya viene el precio con tu 8% del flete sumado desde Python
                display.innerText = '$' + data.total_final + ' MXN';

                container.innerHTML = '';
                mp.bricks().create("wallet", "wallet_container", {
                    initialization: {
                        preferenceId: data.preference_id,
                    },
                });
            })
            .catch(err => {
                console.error("Error fatal:", err);
                display.innerText = "Error 404";
                container.innerHTML = '<p class="text-danger">Error: La ruta /actualizar-pago/ es vieja. Usa /generar-preferencia/</p>';
            });
    }

    // Carga inicial al entrar a la página
    document.addEventListener('DOMContentLoaded', () => {
        actualizarPreferencia(0); 
    });
</script>
